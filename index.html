<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐點訂單管理系統</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 增加 CSS 讓餐點明細對齊 */
        .meal-item {
            display: flex;
            align-items: baseline; /* 確保內容基準線對齊 */
            width: 100%;
        }
        .meal-name {
            flex-grow: 1;
        }
        .meal-count {
            flex-shrink: 0;
            font-weight: bold; /* 將份數設為粗體 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 min-h-screen flex flex-col items-center">
    <!-- 主應用程式容器 -->
    <div class="container mx-auto max-w-4xl p-4 bg-white shadow-xl rounded-xl">
        
        <!-- 標頭區塊：包含分頁與今日營業額 -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-4 md:mb-0">訂單管理系統</h1>
            
            <!-- 分頁按鈕 - 調整 flex 屬性以置中 -->
            <div class="flex-grow flex justify-center">
                <button id="mainPageTab" class="bg-indigo-500 text-white px-6 py-2 rounded-full font-medium transition-colors hover:bg-indigo-600 mr-2">主頁面</button>
                <button id="historyPageTab" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-full font-medium transition-colors hover:bg-gray-400">歷史訂單</button>
            </div>
            
            <!-- 今日營業額顯示 -->
            <div class="flex items-center space-x-2 bg-green-100 text-green-700 font-bold px-4 py-2 rounded-lg shadow-md mt-4 md:mt-0">
                <span>今日營業額:</span>
                <span id="todaysRevenue" class="text-xl">載入中...</span>
            </div>
        </header>

        <!-- 新增刷新頻率控制區塊 -->
        <div class="flex items-center justify-center space-x-2 mb-6">
            <label for="refreshRate" class="font-medium text-gray-700">自動刷新頻率:</label>
            <select id="refreshRate" class="py-1 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="1000">1 秒</option>
                <option value="5000" selected>5 秒</option>
                <option value="15000">15 秒</option>
                <option value="30000">30 秒</option>
            </select>
        </div>

        <!-- 主頁面訂單列表區塊 -->
        <main id="mainPage" class="space-y-4">
            <!-- 將載入訊息移到 ordersList 外面，避免被清除 -->
            <p id="loadingMessage" class="text-center text-gray-500">載入中，請稍候...</p>
            <div id="ordersList" class="grid gap-4">
                <!-- 訂單卡片會在這裡動態生成 -->
            </div>
        </main>
        
        <!-- 歷史訂單列表區塊 -->
        <main id="historyPage" class="space-y-4 hidden">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">歷史訂單</h2>
            <!-- 將載入訊息移到 historyList 外面，避免被清除 -->
            <p id="historyLoadingMessage" class="text-center text-gray-500">載入中，請稍候...</p>
            <div id="historyList" class="grid gap-4">
                <!-- 歷史訂單卡片會在這裡動態生成 -->
            </div>
        </main>

    </div>

    <!-- 訊息模態框 -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300">
        <div class="bg-white rounded-lg p-6 w-80 shadow-lg transform scale-95 transition-transform duration-300">
            <p id="modalMessage" class="text-center text-lg font-medium text-gray-700 mb-4"></p>
            <button id="modalCloseBtn" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-full transition-colors hover:bg-indigo-600">關閉</button>
        </div>
    </div>

    <script type="module">
        // =================================================================
        // ** Important Settings: Please modify based on your Google Sheets and Google Forms **
        // =================================================================
        
        // 1. Google Sheets API link for the original order spreadsheet
        // This is the spreadsheet automatically generated by Google Sheet after users submit orders from the form.
        const ORIGINAL_SHEET_URL = "https://docs.google.com/spreadsheets/d/1GHpU6B0gaPvIUZTarSIN_geddThGLYG9kkodNYARo3c/gviz/tq?tqx=out:csv";
        
        // 2. Google Form submission URL for historical orders
        // This is the form link where we submit processed orders (served or canceled).
        const FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdTf1vWgXAch5YZkBKUX9VJyov6FqjoitHGBa8nBjZjVFl0PA/formResponse";
        
        // 3. Field names (name attribute) of the historical order form
        // !!IMPORTANT!! The "Discount" field name has been replaced with your actual form value.
        const FORM_FIELD_MAPPING = {
            orderId: 'entry.2106562066', 
            mealName: 'entry.99877156', 
            price: 'entry.1051405435', 
            status: 'entry.1208958934', 
            timestamp: 'entry.1529076249',
            discount: 'entry.2101840873' // Updated to the correct "Discount" field name
        };
        
        // 4. Google Sheets API link for the historical order spreadsheet
        // This is the historical order spreadsheet generated by Google Form responses.
        const HISTORY_SHEET_URL = "https://docs.google.com/spreadsheets/d/1xD4X9yGZtEWzU8badXjUWleAaqIxK424ivXkTtdl2SA/gviz/tq?tqx=out:csv&gid=1893877126";

        // =================================================================
        // ** Code Logic, with bug fixes and optimizations **
        // =================================================================

        const mainPage = document.getElementById('mainPage');
        const historyPage = document.getElementById('historyPage');
        const mainPageTab = document.getElementById('mainPageTab');
        const historyPageTab = document.getElementById('historyPageTab');
        const ordersList = document.getElementById('ordersList');
        const historyList = document.getElementById('historyList');
        const todaysRevenueEl = document.getElementById('todaysRevenue');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const refreshRateSelect = document.getElementById('refreshRate'); // New select element
        
        // New variables to reference loading message elements
        const loadingMessageEl = document.getElementById('loadingMessage');
        const historyLoadingMessageEl = document.getElementById('historyLoadingMessage');
        
        let allOrders = []; 
        let processedOrders = [];
        let loadingState = false;

        // Add snapshot variables for data change comparison
        let lastAllOrders = JSON.stringify([]);
        let lastProcessedOrders = JSON.stringify([]);
        let refreshIntervalId; // Stores the setInterval ID

        // Show message modal
        const showModal = (message) => {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        };

        // Hide message modal
        const hideModal = () => {
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('opacity-0');
            }, 300);
        };
        modalCloseBtn.addEventListener('click', hideModal);

        // Handle HTTP requests and parse CSV, with exponential backoff retry
        const fetchCSV = async (url, retries = 3, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const cacheBustingUrl = `${url}&t=${Date.now()}`;
                    const response = await fetch(cacheBustingUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP Error! Status: ${response.status}`);
                    }
                    const text = await response.text();
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    if (lines.length <= 1) {
                        return [];
                    }
                    
                    const firstLine = lines[0].startsWith('\ufeff') ? lines[0].substring(1) : lines[0];
                    const headers = firstLine.split(',').map(header => header.trim().replace(/\"/g, ''));
                    
                    return lines.slice(1).map(line => {
                        // Use regex to handle fields with commas, e.g., "Meal Details"
                        const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                        if (!values || values.length !== headers.length) {
                             console.warn('忽略不完整或格式錯誤的行:', line);
                            return null;
                        }
                        return headers.reduce((obj, header, index) => {
                            const value = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                            obj[header] = value;
                            return obj;
                        }, {});
                    }).filter(Boolean);
                } catch (error) {
                    console.error(`讀取試算表失敗 (嘗試 ${i + 1}):`, error);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        };

        // Format Google Sheets timestamp string to a Date object
        const parseGoogleSheetTimestamp = (timestamp) => {
            if (!timestamp) return null;
            // Handle "2025/8/10 下午 6:07:56" format
            const parts = timestamp.split(' ');
            if (parts.length < 3) {
                // Handle formats that might come from Google Forms, e.g., "2025/8/10 18:07:56"
                const dateParts = timestamp.split(/[\s/:]/);
                if (dateParts.length >= 6) {
                    return new Date(dateParts[0], dateParts[1]-1, dateParts[2], dateParts[3], dateParts[4], dateParts[5]);
                }
                return new Date(timestamp); // If format doesn't match, try to parse directly
            }

            const datePart = parts[0];
            const ampmPart = parts[1];
            const timePart = parts[2];
            
            const [year, month, day] = datePart.split('/');
            let [hour, minute, second] = timePart.split(':');
            
            hour = parseInt(hour, 10);
            if (ampmPart === '下午' && hour !== 12) {
                hour += 12;
            } else if (ampmPart === '上午' && hour === 12) {
                hour = 0;
            }

            const formattedDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T${String(hour).padStart(2, '0')}:${minute}:${second}`;
            return new Date(formattedDate);
        };
        
        // Format as "下午 8:52:43" format
        const formatTimestampForDisplay = (timestamp) => {
            if (!timestamp) return '';
            const date = parseGoogleSheetTimestamp(timestamp);
            if (!date) return timestamp;

            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            let hour = date.getHours();
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            let ampm = '上午';

            if (hour >= 12) {
                ampm = '下午';
                if (hour > 12) {
                    hour -= 12;
                }
            } else if (hour === 0) {
                hour = 12;
            }
            
            return `${year}/${month}/${day} ${ampm} ${hour}:${minute}:${second}`;
        };

        // Get all order data and check for changes
        const fetchData = async () => {
            if (loadingState) return;
            loadingState = true;
            
            // Show loading message on first load
            if (ordersList.innerHTML === '') {
                loadingMessageEl.classList.remove('hidden');
            }
            if (historyList.innerHTML === '') {
                historyLoadingMessageEl.classList.remove('hidden');
            }
            
            try {
                const [originalData, historyData] = await Promise.all([
                    fetchCSV(ORIGINAL_SHEET_URL),
                    fetchCSV(HISTORY_SHEET_URL)
                ]);

                const newAllOrders = originalData.map(order => {
                    return {
                        '時間戳記': order['時間戳記'],
                        '手機末四碼': order['手機末四碼'] || order['手機末4碼'] || '', 
                        '餐點明細': order['餐點明細'] || order['訂餐明細'] || '', 
                        '總金額': order['總金額'] || order['價格'] || '0', 
                    }
                }).filter(order => order['時間戳記']); 

                const newProcessedOrders = historyData.filter(order => order['時間戳記']).map(order => {
                    const orderIdParts = (order['手機末四碼'] || '').split('_');
                    const originalTimestampFromId = orderIdParts.length > 1 ? orderIdParts.slice(1).join('_') : '';
                    
                    return {
                        '訂單時間戳記': order['時間戳記'],
                        '訂單編號': orderIdParts[0] || '???',
                        '原始時間戳記': originalTimestampFromId,
                        '餐點名稱': order['餐點明細'],
                        '價格': order['總金額'],
                        '狀態': order['狀態 (已出餐/已取消)'],
                        '折扣': order['折扣'], // Read new discount field
                    };
                });
                
                // Check if data has changed, only update UI if there are changes
                const currentAllOrders = JSON.stringify(newAllOrders);
                const currentProcessedOrders = JSON.stringify(newProcessedOrders);

                if (currentAllOrders !== lastAllOrders || currentProcessedOrders !== lastProcessedOrders) {
                    allOrders = newAllOrders;
                    processedOrders = newProcessedOrders;
                    renderUI();
                    
                    // Update snapshot
                    lastAllOrders = currentAllOrders;
                    lastProcessedOrders = currentProcessedOrders;
                }

            } catch (error) {
                console.error('讀取資料失敗:', error);
                showModal('讀取資料失敗，請檢查網路或試算表網址。');
            } finally {
                loadingState = false;
                // Ensure loading message is hidden after the first load
                loadingMessageEl.classList.add('hidden');
                historyLoadingMessageEl.classList.add('hidden');
            }
        };
        
        // Submit order status to Google Form
        const submitToForm = async (order, status) => {
            const orderTimestamp = order['時間戳記'];
            const orderMealName = order['餐點明細'] || ''; 
            const orderPrice = order.finalPrice; // Use final price after discount calculation
            const orderTableNumber = order['手機末四碼'] || '';
            const orderDiscount = order.discountValue; // New: get discount value

            // When submitting to the form, combine the original timestamp with the last four digits of the phone number
            const formOrderId = `${orderTableNumber}_${orderTimestamp}`;
            
            const formData = new FormData();
            formData.append(FORM_FIELD_MAPPING.orderId, formOrderId);
            formData.append(FORM_FIELD_MAPPING.mealName, orderMealName);
            formData.append(FORM_FIELD_MAPPING.price, orderPrice);
            formData.append(FORM_FIELD_MAPPING.status, status);
            formData.append(FORM_FIELD_MAPPING.timestamp, orderTimestamp);
            formData.append(FORM_FIELD_MAPPING.discount, orderDiscount); // New: submit discount value

            try {
                showModal('提交中...請稍候');
                await fetch(FORM_ACTION_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' 
                });

                await fetchData();
                showModal(`訂單狀態已成功提交為「${status}」！`);
            } catch (error) {
                console.error('提交表單失敗:', error);
                showModal('提交表單時發生錯誤，請檢查網路或表單設定。');
            }
        };
        
        // 修正後的函式：正確地合併並計數餐點明細
        const formatMealDetails = (details) => {
            if (!details) return '無餐點明細';
            
            const mealCounts = {};
            const items = details.split(',').map(item => item.trim()).filter(item => item.length > 0);
            
            items.forEach(item => {
                const match = item.match(/(.+)\(x\s*(\d+)\s*份\)/);
                if (match) {
                    const mealName = match[1].trim();
                    const count = parseInt(match[2], 10);
                    mealCounts[mealName] = (mealCounts[mealName] || 0) + count;
                } else {
                    // Handle cases without "(x N 份)"
                    mealCounts[item] = (mealCounts[item] || 0) + 1;
                }
            });

            const sortedMeals = Object.keys(mealCounts).sort((a, b) => a.localeCompare(b, 'zh-TW'));
            
            return sortedMeals.map(mealName => {
                const count = mealCounts[mealName];
                // 使用 Tailwind CSS 調整間距，並將份數設為粗體
                return `<div class="meal-item"><span class="meal-name">${mealName}</span><span class="meal-count text-center ml-2">x ${count}</span></div>`;
            }).join('');
        };

        // Render UI for main page and history page
        const renderUI = () => {
             // Use original timestamp for comparison
            const processedTimestamps = new Set(processedOrders.map(order => {
                // Convert historical order's original timestamp to a unified format
                return formatTimestampForDisplay(order['原始時間戳記']);
            }).filter(Boolean));

            const pendingOrders = allOrders.filter(order => {
                const originalTimestampFormatted = formatTimestampForDisplay(order['時間戳記']);
                return originalTimestampFormatted && !processedTimestamps.has(originalTimestampFormatted);
            });
            
            renderOrders(pendingOrders, ordersList, false);
            renderOrders(processedOrders, historyList, true);
            renderTodaysRevenue();
        };

        const renderOrders = (orders, container, isHistory) => {
            container.innerHTML = '';
            if (orders.length === 0) {
                const message = isHistory ? '目前沒有歷史訂單' : '目前沒有待處理訂單';
                container.innerHTML = `<p class="text-center text-gray-500 py-4">${message}</p>`;
                return;
            }
            
            if (isHistory) {
                orders.sort((a, b) => {
                    const dateA = parseGoogleSheetTimestamp(a['訂單時間戳記']);
                    const dateB = parseGoogleSheetTimestamp(b['訂單時間戳記']);
                    return dateB - dateA;
                });
            } else {
                orders.sort((a, b) => {
                    const dateA = parseGoogleSheetTimestamp(a['時間戳記']);
                    const dateB = parseGoogleSheetTimestamp(b['時間戳記']);
                    return dateA - dateB;
                });
            }

            orders.forEach(order => {
                const orderTimestamp = isHistory ? order['訂單時間戳記'] : order['時間戳記']; 
                const orderMealName = isHistory ? order['餐點名稱'] : order['餐點明細'] || '無餐點明細';
                const orderPrice = isHistory ? order['價格'] : order['總金額'] || '0';
                const orderTableNumber = isHistory ? (order['訂單編號'] ? order['訂單編號'] : '???') : (order['手機末四碼'] || '???');
                const historyStatus = isHistory ? order['狀態'] : '';
                const isDeleted = historyStatus === '已取消';
                
                // Store original price in data object for later calculation
                order.originalPrice = parseFloat(orderPrice) || 0;
                order.finalPrice = order.originalPrice;
                order.discountValue = 10;

                const displayTimestamp = isHistory ? orderTimestamp : formatTimestampForDisplay(orderTimestamp);
                
                const discountValueFromHistory = isHistory ? order['折扣'] : '10';
                const isDiscounted = parseInt(discountValueFromHistory, 10) < 10;
                
                // Use formatMealDetails function to format meal details
                const formattedMealDetails = formatMealDetails(orderMealName);
                
                // Generate red discount tag based on discount value
                const discountLabel = isDiscounted ? `
                    <span class="text-xs font-normal ml-2 py-0.5 px-2 rounded-full text-white bg-red-500">
                        ${parseInt(discountValueFromHistory, 10)}折
                    </span>` : '';

                const orderCard = document.createElement('div');
                orderCard.className = `bg-white p-6 rounded-xl shadow-md transition-shadow hover:shadow-lg flex flex-col md:flex-row justify-between items-start md:items-center ${isDeleted ? 'bg-red-100' : ''}`;
                orderCard.innerHTML = `
                    <div class="flex-grow mb-4 md:mb-0 md:mr-6">
                        <div class="flex items-baseline space-x-2 text-xl font-bold">
                            <span class="text-blue-600 text-2xl font-extrabold mr-2">#${orderTableNumber}</span>
                            <span class="text-gray-900 text-sm font-light">${displayTimestamp}</span>
                            <!-- Show historical order status, if served it will show a green tag, if canceled it will show a red tag -->
                            ${isHistory ? `<span class="text-sm font-normal ml-2 py-1 px-2 rounded-full text-white ${isDeleted ? 'bg-red-500' : 'bg-green-500'}">${historyStatus}</span>` : ''}
                            <!-- Show a red discount tag next to the status tag -->
                            ${isHistory ? discountLabel : ''}
                        </div>
                        <p class="text-gray-600 mt-2">餐點明細: <br>${formattedMealDetails}</p>
                        <br>
                        <p class="text-lg font-semibold text-gray-900">價格: <span class="priceDisplay">NT$${parseFloat(orderPrice).toLocaleString()}</span></p>
                    </div>
                    <div class="flex flex-col space-y-2 w-full md:w-auto flex-shrink-0">
                        ${!isHistory ? `
                            <div class="flex items-center space-x-2">
                                <label for="discount-${orderTimestamp}" class="text-gray-700 font-medium whitespace-nowrap">折扣：</label>
                                <select id="discount-${orderTimestamp}" class="discountSelect py-1 px-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 w-full">
                                    <option value="10">不打折</option>
                                    <option value="9">9折</option>
                                    <option value="8">8折</option>
                                    <option value="7">7折</option>
                                    <option value="6">6折</option>
                                    <option value="5">5折</option>
                                    <option value="4">4折</option>
                                    <option value="3">3折</option>
                                    <option value="2">2折</option>
                                    <option value="1">1折</option>
                                </select>
                            </div>
                            <button class="confirmBtn bg-green-500 text-white font-bold py-2 px-4 rounded-full transition-transform hover:scale-105 active:scale-95 shadow-md" data-timestamp="${order['時間戳記']}">
                                確認出餐
                            </button>
                            <button class="deleteBtn bg-red-500 text-white font-bold py-2 px-4 rounded-full transition-transform hover:scale-105 active:scale-95 shadow-md" data-timestamp="${order['時間戳記']}">
                                刪除餐點
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(orderCard);
                
                if (!isHistory) {
                    const discountSelect = orderCard.querySelector('.discountSelect');
                    const priceDisplay = orderCard.querySelector('.priceDisplay');
                    
                    discountSelect.addEventListener('change', (e) => {
                        const discount = parseInt(e.target.value, 10);
                        const newPrice = order.originalPrice * (discount / 10);
                        order.finalPrice = newPrice;
                        order.discountValue = discount;
                        priceDisplay.textContent = `NT$${newPrice.toLocaleString()}`;
                    });
                }
            });

            if (!isHistory) {
                container.querySelectorAll('.confirmBtn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const timestamp = e.target.dataset.timestamp;
                        const orderToProcess = allOrders.find(o => o['時間戳記'] === timestamp);
                        if (orderToProcess) {
                            const discountSelectElement = e.target.closest('.flex-col').querySelector('.discountSelect');
                            orderToProcess.discountValue = discountSelectElement ? parseInt(discountSelectElement.value, 10) : 10;
                            submitToForm(orderToProcess, '已出餐');
                        }
                    });
                });
                container.querySelectorAll('.deleteBtn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const timestamp = e.target.dataset.timestamp;
                        const orderToProcess = allOrders.find(o => o['時間戳記'] === timestamp);
                        if (orderToProcess) {
                            const discountSelectElement = e.target.closest('.flex-col').querySelector('.discountSelect');
                            orderToProcess.discountValue = discountSelectElement ? parseInt(discountSelectElement.value, 10) : 10;
                            submitToForm(orderToProcess, '已取消');
                        }
                    });
                });
            }
        };

        const renderTodaysRevenue = () => {
            const today = new Date().toLocaleDateString('zh-TW');
            
            const todaysConfirmedOrders = processedOrders.filter(order => {
                const orderTimestamp = order['訂單時間戳記']; 
                if (!orderTimestamp) return false;
                
                const date = parseGoogleSheetTimestamp(orderTimestamp);
                if (isNaN(date.getTime())) return false;
                
                const formattedOrderDate = date.toLocaleDateString('zh-TW');
                return formattedOrderDate === today && order['狀態'] === '已出餐';
            });
            
            const totalRevenue = todaysConfirmedOrders.reduce((sum, order) => {
                const price = parseFloat(order['價格']) || 0;
                return sum + price;
            }, 0);
            
            todaysRevenueEl.textContent = `NT$${totalRevenue.toLocaleString()}`;
        };

        const switchTab = (activeTab, inactiveTab, activePage, inactivePage) => {
            activeTab.classList.remove('bg-gray-300', 'text-gray-700');
            activeTab.classList.add('bg-indigo-500', 'text-white');
            inactiveTab.classList.remove('bg-indigo-500', 'text-white');
            inactiveTab.classList.add('bg-gray-300', 'text-gray-700');
            activePage.classList.remove('hidden');
            inactivePage.classList.add('hidden');
        };

        // Reset auto-refresh
        const setRefreshInterval = (interval) => {
            clearInterval(refreshIntervalId); // Clear old timer
            refreshIntervalId = setInterval(fetchData, interval); // Set new timer
        };

        // Listen for changes in the refresh rate select
        refreshRateSelect.addEventListener('change', (e) => {
            const newInterval = parseInt(e.target.value, 10);
            setRefreshInterval(newInterval);
        });

        mainPageTab.addEventListener('click', () => {
            switchTab(mainPageTab, historyPageTab, mainPage, historyPage);
        });

        historyPageTab.addEventListener('click', () => {
            switchTab(historyPageTab, mainPageTab, historyPage, mainPage);
        });

        window.onload = () => {
            fetchData();
            // Set initial refresh to 5 seconds
            setRefreshInterval(5000); 
        };
    </script>
</body>
</html>
